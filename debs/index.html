<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Omar-Cydia /debs</title>
  <style>
    body {
      margin: 0;
      padding: 24px;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: #0b1020;
      color: #e7efff;
    }

    .card {
      max-width: 900px;
      margin: 0 auto;
      background: #131a30;
      border: 1px solid #2a365f;
      border-radius: 16px;
      padding: 20px;
    }

    h1 { margin-top: 0; }
    p { color: #9bb0d6; }
    a { color: #8feaff; }

    .list {
      list-style: none;
      padding: 0;
      margin: 16px 0 0;
      display: grid;
      gap: 10px;
    }

    .item {
      background: #0f1529;
      border: 1px solid #2a365f;
      border-radius: 10px;
      padding: 10px 12px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .meta { color: #9bb0d6; font-size: .9rem; }
  </style>
</head>
<body>
  <main class="card">
    <h1>üì¶ /debs</h1>
    <p>Auto-loaded from <code>Packages</code> and <code>Packages.gz</code>. No manual HTML editing needed.</p>
    <p><a href="../">‚Üê Back to home</a></p>
    <p id="status">Loading packages...</p>
    <ul id="deb-list" class="list"></ul>
  </main>

  <script>
    const statusEl = document.getElementById('status');
    const listEl = document.getElementById('deb-list');

    function parseStanzas(text, sourceName) {
      const stanzas = text.trim().split(/\n\s*\n/).filter(Boolean);
      const items = [];

      for (const stanza of stanzas) {
        let name = '';
        let pkg = '';
        let version = '';
        let filename = '';

        for (const line of stanza.split('\n')) {
          if (line.startsWith('Name: ')) name = line.slice(6).trim();
          if (line.startsWith('Package: ')) pkg = line.slice(9).trim();
          if (line.startsWith('Version: ')) version = line.slice(9).trim();
          if (line.startsWith('Filename: ')) filename = line.slice(10).trim();
        }

        if (filename) {
          items.push({
            key: `${pkg || name}-${version}-${filename}`,
            name: name || pkg || filename.split('/').pop(),
            version: version || 'Unknown',
            href: `../${filename}`,
            source: sourceName,
          });
        }
      }

      return items;
    }

    async function readSource(path) {
      const response = await fetch(`../${path}`, { cache: 'no-store' });
      if (!response.ok) throw new Error(`${path} HTTP ${response.status}`);

      if (!path.endsWith('.gz')) return await response.text();

      const bytes = new Uint8Array(await response.arrayBuffer());
      const isGzip = bytes[0] === 0x1f && bytes[1] === 0x8b;
      if (!isGzip) return new TextDecoder().decode(bytes);

      if ('DecompressionStream' in window) {
        const ds = new DecompressionStream('gzip');
        const stream = new Blob([bytes]).stream().pipeThrough(ds);
        return await new Response(stream).text();
      }

      throw new Error('Browser cannot decompress Packages.gz.');
    }

    async function loadDebs() {
      const sources = ['Packages', 'Packages.gz'];
      const combined = [];
      const loaded = [];

      for (const source of sources) {
        try {
          const text = await readSource(source);
          const parsed = parseStanzas(text, source);
          if (parsed.length) {
            combined.push(...parsed);
            loaded.push(source);
          }
        } catch (err) {
          console.warn(`Unable to load ${source}:`, err.message);
        }
      }

      const seen = new Set();
      const deduped = combined.filter((item) => {
        if (seen.has(item.key)) return false;
        seen.add(item.key);
        return true;
      });

      if (!deduped.length) {
        statusEl.textContent = 'No packages found. Update Packages / Packages.gz.';
        return;
      }

      statusEl.textContent = `Loaded ${deduped.length} package(s) from ${loaded.join(' + ')}.`;
      listEl.innerHTML = deduped.map((item) => `
        <li class="item">
          <span>${item.name} (${item.version})</span>
          <span class="meta"><a href="${item.href}">Download</a> ‚Ä¢ ${item.source}</span>
        </li>
      `).join('');
    }

    loadDebs();
  </script>
</body>
</html>
