<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <meta charset="UTF-8">
  <title>Omar-Cydia Repo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root { --bg:#090b14; --card:#121728; --card-soft:#191f34; --text:#ebf2ff; --muted:#9db2d5; --accent:#6ee7ff; --ok:#22c55e; }
    * { box-sizing:border-box; }
    body { margin:0; font-family:Inter,system-ui,sans-serif; color:var(--text); background:radial-gradient(1200px 600px at 10% -10%,#1c2b5f66 0%,transparent 60%),radial-gradient(1000px 500px at 100% 0%,#4f1d6d66 0%,transparent 60%),var(--bg); min-height:100vh; }
    .container { max-width:1080px; margin:0 auto; padding:28px 18px 60px; }
    .hero,.details { background:linear-gradient(145deg,#171f39,#101525); border:1px solid #2b355c; border-radius:22px; padding:24px; box-shadow:0 18px 60px #00000066; }
    h1 { margin:0 0 8px; font-size:clamp(1.8rem,3vw,2.7rem); }
    .subtitle { margin:0 0 14px; color:var(--muted); }
    code { display:inline-block; background:#0c1222; border:1px solid #2a355f; border-radius:10px; padding:10px 12px; color:#9ce6ff; font-size:.95rem; word-break:break-all; }
    .quick-links { display:flex; gap:10px; flex-wrap:wrap; margin-top:16px; }
    .chip { text-decoration:none; color:var(--text); border:1px solid #33406c; background:#151d35; border-radius:999px; padding:8px 14px; font-size:.9rem; }
    .stats { margin-top:16px; display:grid; grid-template-columns:repeat(3,minmax(120px,1fr)); gap:12px; }
    .stat { background:var(--card-soft); border:1px solid #2f3a63; border-radius:14px; padding:12px; }
    .stat .label { color:var(--muted); font-size:.85rem; } .stat .value { font-size:1.25rem; font-weight:700; margin-top:6px; }
    .section-title { margin:28px 0 12px; display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    #search { background:#0f1528; border:1px solid #2f3d69; border-radius:12px; color:var(--text); padding:10px 12px; min-width:230px; }
    #status { color:var(--muted); margin:0 0 14px; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:14px; }
    .pkg { background:linear-gradient(160deg,#151c32,#111729); border:1px solid #2f3a63; border-radius:16px; padding:14px; cursor:pointer; transition:.15s transform,.15s border-color; }
    .pkg:hover { transform:translateY(-2px); border-color:#5a6fb0; }
    .pkg.active { border-color:#7fdfff; box-shadow:0 0 0 1px #7fdfff55 inset; }
    .pkg h3 { margin:0 0 8px; font-size:1.05rem; }
    .meta { color:var(--muted); font-size:.87rem; margin-bottom:10px; }
    .download { display:inline-flex; align-items:center; gap:6px; text-decoration:none; color:#03131a; background:linear-gradient(90deg,var(--accent),#90f2ff); font-weight:700; border-radius:10px; padding:8px 12px; }
    .source-tag { display:inline-block; margin-left:8px; padding:3px 8px; border-radius:999px; font-size:.72rem; color:#ddf8ff; background:linear-gradient(120deg,#2f3a63,#3b2c61); }
    .details { margin-top:16px; }
    .details h3 { margin-top:0; }
    .kv { display:grid; grid-template-columns:150px 1fr; gap:8px 14px; }
    .k { color:var(--muted); } .v { word-break:break-word; }
    .music-controls { margin-top:14px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .music-btn-stack { position:relative; width:130px; height:38px; }
    .music-btn { position:absolute; inset:0; border:1px solid #35518a; background:#14203d; color:#dff5ff; border-radius:10px; padding:8px 12px; cursor:pointer; }
    .music-btn.hidden { display:none; }
    .music-state { color:var(--muted); font-size:.9rem; }
    .footer { margin-top:24px; color:var(--muted); text-align:center; }
    @media (max-width:640px){ .stats{grid-template-columns:1fr;} #search{width:100%;min-width:0;} .kv{grid-template-columns:1fr;} }
  </style>
</head>
<body>
  <main class="container">
    <section class="hero">
      <h1>üî• Omar  Cydia Repo</h1>
      <p class="subtitle">Click any tweak/package card to see full metadata parsed from Packages files.</p>
      <code>https://omararaj2170.github.io/Omar-Cydia/</code>
      <div class="quick-links">
        <a class="chip" href="Packages">Packages</a><a class="chip" href="Packages.gz">Packages.gz</a><a class="chip" href="Release">Release</a><a class="chip" href="debs/">debs/</a>
      </div>

      <div class="music-controls">
        <div class="music-btn-stack">
          <button id="stop-music" class="music-btn" type="button">‚èπ Stop Music</button>
          <button id="play-music" class="music-btn hidden" type="button">‚ñ∂ Play Music</button>
        </div>
        <span id="music-state" class="music-state">Trying to autoplay <code>music/1.mp3</code>...</span>
      </div>
      <audio id="bg-music" src="music/1.mp3" preload="auto" autoplay loop></audio>

      <div class="stats">
        <div class="stat"><div class="label">Total Packages</div><div class="value" id="total-packages">-</div></div>
        <div class="stat"><div class="label">Sources Loaded</div><div class="value" id="sources-loaded">-</div></div>
        <div class="stat"><div class="label">Status</div><div class="value" id="load-state">Loading</div></div>
      </div>
    </section>

    <section>
      <div class="section-title"><h2 style="margin:0;">üì¶ Available Packages</h2><input id="search" type="search" placeholder="Search package name or version..." /></div>
      <p id="status">Loading package metadata from <code>Packages</code> and <code>Packages.gz</code>...</p>
      <div id="packages" class="grid"></div>
    </section>

    <section class="details" id="details">
      <h3>Package details</h3>
      <p class="meta" id="details-help">Click a package card to view all metadata fields.</p>
      <div class="kv" id="details-grid"></div>
    </section>

    <p class="footer">Made with ‚ù§Ô∏è by Omar</p>
  </main>

  <script>
    const packagesEl = document.getElementById('packages');
    const statusEl = document.getElementById('status');
    const totalEl = document.getElementById('total-packages');
    const sourcesEl = document.getElementById('sources-loaded');
    const stateEl = document.getElementById('load-state');
    const searchEl = document.getElementById('search');
    const detailsGrid = document.getElementById('details-grid');
    const detailsHelp = document.getElementById('details-help');
    const bgMusic = document.getElementById('bg-music');
    const stopMusicBtn = document.getElementById('stop-music');
    const playMusicBtn = document.getElementById('play-music');
    const musicState = document.getElementById('music-state');

    let allPackages = [];

    function parseStanzas(text, sourceName) {
      const stanzas = text.trim().split(/\n\s*\n/).filter(Boolean);
      return stanzas.map((stanza) => {
        const fields = {};
        for (const line of stanza.split('\n')) {
          const i = line.indexOf(':');
          if (i > 0) fields[line.slice(0, i).trim()] = line.slice(i + 1).trim();
        }
        const filename = fields.Filename || '';
        return {
          key: `${fields.Package || fields.Name || filename}-${fields.Version || ''}-${filename}`,
          name: fields.Name || fields.Package || filename.split('/').pop() || 'Unknown',
          packageId: fields.Package || '',
          version: fields.Version || 'Unknown',
          filename,
          description: fields.Description || 'No description provided.',
          source: sourceName,
          fields
        };
      }).filter((x) => x.filename);
    }

    async function readSource(path) {
      const response = await fetch(path, { cache: 'no-store' });
      if (!response.ok) throw new Error(`${path} HTTP ${response.status}`);
      if (!path.endsWith('.gz')) return await response.text();
      const bytes = new Uint8Array(await response.arrayBuffer());
      const isGzip = bytes[0] === 0x1f && bytes[1] === 0x8b;
      if (!isGzip) return new TextDecoder().decode(bytes);
      if ('DecompressionStream' in window) {
        const stream = new Blob([bytes]).stream().pipeThrough(new DecompressionStream('gzip'));
        return await new Response(stream).text();
      }
      throw new Error('This browser cannot decompress Packages.gz.');
    }

    function showDetails(item) {
      detailsHelp.textContent = `${item.name} (${item.version}) ‚Ä¢ loaded from ${item.source}`;
      const important = ['Package','Name','Version','Architecture','Description','Depends','Pre-Depends','Maintainer','Section','Filename','Size'];
      const entries = Object.entries(item.fields);
      entries.sort((a,b)=>{
        const ai = important.indexOf(a[0]);
        const bi = important.indexOf(b[0]);
        return (ai===-1?999:ai) - (bi===-1?999:bi) || a[0].localeCompare(b[0]);
      });
      detailsGrid.innerHTML = entries.map(([k,v]) => `<div class="k">${k}</div><div class="v">${v || '-'}</div>`).join('');
      document.querySelectorAll('.pkg').forEach((el)=>el.classList.remove('active'));
      const active = document.querySelector(`[data-key="${CSS.escape(item.key)}"]`);
      if (active) active.classList.add('active');
    }

    function render(list) {
      if (!list.length) {
        packagesEl.innerHTML = '<div class="pkg"><h3>No packages found</h3><div class="meta">Try updating Packages / Packages.gz.</div></div>';
        detailsGrid.innerHTML = '';
        return;
      }
      packagesEl.innerHTML = list.map((item) => `
        <article class="pkg" data-key="${item.key}">
          <h3>${item.name}<span class="source-tag">${item.source}</span></h3>
          <div class="meta">${item.packageId ? `${item.packageId} ‚Ä¢ ` : ''}v${item.version}</div>
          <div class="meta">${item.description}</div>
          <a class="download" href="${item.filename}">‚¨á Download .deb</a>
        </article>
      `).join('');
      document.querySelectorAll('.pkg').forEach((card) => {
        card.addEventListener('click', (e) => {
          if (e.target.closest('a')) return;
          const found = list.find((x) => x.key === card.dataset.key);
          if (found) showDetails(found);
        });
      });
      showDetails(list[0]);
    }

    function applySearch() {
      const q = searchEl.value.trim().toLowerCase();
      const filtered = allPackages.filter((item) => item.name.toLowerCase().includes(q) || item.packageId.toLowerCase().includes(q) || item.version.toLowerCase().includes(q));
      render(filtered);
      statusEl.textContent = q ? `Showing ${filtered.length} result(s) for "${q}".` : `Showing all ${allPackages.length} package(s).`;
    }

    async function loadPackages() {
      const sources = ['Packages', 'Packages.gz'];
      const loadedSources = [];
      const combined = [];
      for (const source of sources) {
        try {
          const parsed = parseStanzas(await readSource(source), source);
          if (parsed.length) { combined.push(...parsed); loadedSources.push(source); }
        } catch (err) { console.warn(`Unable to load ${source}:`, err.message); }
      }
      const deduped = []; const seen = new Set();
      for (const item of combined) { if (!seen.has(item.key)) { seen.add(item.key); deduped.push(item); } }
      allPackages = deduped;
      render(allPackages);
      totalEl.textContent = String(allPackages.length);
      sourcesEl.textContent = loadedSources.length ? loadedSources.join(', ') : 'None';
      stateEl.textContent = loadedSources.length ? 'Online' : 'No Data';
      stateEl.style.color = loadedSources.length ? 'var(--ok)' : '#fca5a5';
      statusEl.textContent = loadedSources.length ? `Loaded ${allPackages.length} package(s) from ${loadedSources.join(' + ')}.` : 'Could not load package metadata. Check Packages / Packages.gz.';
    }


    async function startMusic() {
      try {
        await bgMusic.play();
        musicState.textContent = '‚ñ∂ Music playing (music/1.mp3)';
        stopMusicBtn.classList.remove('hidden');
        playMusicBtn.classList.add('hidden');
      } catch (err) {
        musicState.textContent = 'Autoplay was blocked by browser. Tap anywhere to start music.';
        const resume = async () => {
          try {
            await bgMusic.play();
            musicState.textContent = '‚ñ∂ Music playing (music/1.mp3)';
            stopMusicBtn.classList.remove('hidden');
            playMusicBtn.classList.add('hidden');
          } catch {}
          document.removeEventListener('click', resume);
        };
        document.addEventListener('click', resume, { once: true });
      }
    }

    stopMusicBtn.addEventListener('click', () => {
      bgMusic.pause();
      bgMusic.currentTime = 0;
      musicState.textContent = '‚èπ Music stopped';
      stopMusicBtn.classList.add('hidden');
      playMusicBtn.classList.remove('hidden');
    });

    playMusicBtn.addEventListener('click', async () => {
      try {
        await bgMusic.play();
        musicState.textContent = '‚ñ∂ Music playing (music/1.mp3)';
        playMusicBtn.classList.add('hidden');
        stopMusicBtn.classList.remove('hidden');
      } catch {
        musicState.textContent = 'Could not play music yet. Tap again.';
      }
    });

    searchEl.addEventListener('input', applySearch);
    loadPackages();
    startMusic();
  </script>
</body>
</html>
